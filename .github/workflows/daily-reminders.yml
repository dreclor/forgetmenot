# Calls your Supabase Edge Function once per day so reminder push notifications are sent.
# Requires: repo on GitHub + secret SUPABASE_REMINDERS_FUNCTION_URL (the function URL).

name: Daily reminders

on:
  schedule:
    # 9:00 AM UTC every day (adjust cron for your timezone if needed)
    - cron: '0 9 * * *'
  workflow_dispatch: # allows manual "Run workflow" from GitHub Actions tab

jobs:
  trigger-reminders:
    runs-on: ubuntu-latest
    steps:
      - name: Call send-due-reminders
        run: |
          echo "Calling Edge Function..."
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.SUPABASE_REMINDERS_FUNCTION_URL }}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          echo "Status: $http_code"
          echo "Response: $body"
          if echo "$body" | grep -q '"log":'; then
            echo ""
            echo "--- Function log ---"
            echo "$body" | python3 -c "import sys,json; d=json.load(sys.stdin); [print(' ', m) for m in d.get('log',[])]" 2>/dev/null || true
            echo "--------------------"
          fi
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Function returned non-2xx; failing the step."
            exit 1
          fi